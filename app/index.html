<html>
<head>
<title>WebM Dashboard</title>
<link rel="stylesheet" type="text/css" href="/css/main.css"/>

<!-- The majority of our javascript -->
<script type="text/javascript" src="/js/jstree/_lib/jquery.js"></script>
<script type="text/javascript" src="/js/jstree/jquery.jstree.js"></script>
<link rel="stylesheet" type="text/css" href="/js/jquery-ui/css/smoothness/jquery-ui-1.8.21.custom.css" />
<script type="text/javascript" src="/js/jquery-ui/js/jquery-ui-1.8.21.custom.min.js"></script>

<!-- Making an AJAX request to a local server function ------------------------>
<script type="text/javascript" src="/js/json2.js"></script>
<script type="text/javascript">

function range(start, end)
{
  var foo = [];
  for (var i = start; i <= end; i++)
    foo.push(i);
  return foo;
}

var MetricState = new Array();
var ConfigState = new Array();
var FileState = new Array();
var CommitState = new Array();

</script>
<script type="text/javascript" src="/js/treehandler.js"></script>

<!-- the AJAX API for google charts -->
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script>
google.load('visualization', '1.0', {'packages':['corechart', 'table']});

function ChartFiller() {
  var responses = new Array();

  var queryNum = MetricState.length * ConfigState.length *
                 FileState.length * CommitState.length;
  //$('#tabs3').html(queryNum);

  // Wait until all data is fetched to generate graphs
  $(document).ajaxStop(function() {
    $(this).unbind("ajaxStop");
    if (responses.length > 0) {
      drawChart(responses);
    }
    else {
      $('#tabs11').html("Please select a valid run.");
    }
  });

  var files = FileState.filter(removeParents);
  var commits = CommitState.filter(removeParents);
  // Ew, quadruple nested loop
  for (var i = 0; i < MetricState.length; i++) {
    for (var j = 0; j < ConfigState.length; j++) {
      for (var k = 0; k < files.length; k++) {
        for (var t = 0; t < commits.length; t++) {
          // We put together a url
          var metric = MetricState[i];
          var config = ConfigState[j];
          var file = files[k];
          var commit = commits[t];
          metricurl = "/metric-data/" + metric + "/" + config + "/" + file + "/" + commit

          $.ajax({
            type: "GET",
            url: metricurl,
            success: function(response){
              responses.push([response, this.url]);
            },
          });
        }
      }
    }
  }
}

function StatisticFiller() {
  // This function is reponsible for filling a table with the composite metrics
  // for each file

  // We ask the backend for a chart to display - based on metric, fileset,
  // config, and commit selected.

  var metrics = MetricState.join(",");
  var configs = ConfigState.join(",");
  var files = FileState.filter(removeParents).join(",");
  var commits = CommitState.filter(removeParents).join(",");
  var compurl = "/average-improvement/" + metrics + "/" + configs + "/" + files + "/" + commits;

  // What baseline should the curves be compared to?
  $.ajax({
    type: "GET",
    url: compurl,
    success: function(response){
      response = eval(response);
      if (response.length > 0) {
        //$('#tabs3').html(response);
        ImprovementTable(response);
      }
    },
  });

}

function ImprovementTable(data_in) {
  numCol = data_in.length;
  var data1 = new google.visualization.DataTable();
  var view;
  var data2;

  // We fill our table
  data1.addColumn('string', 'Filename');
  data1.addColumn('number', data_in[0].col);
  data1.addRows(data_in[0].data);

  // Make it a chart
  view = new google.visualization.DataView(data1);

  for (var i = 1; i < numCol; i++){
    data2 = new google.visualization.DataTable();
    data2.addColumn('string', 'Filename');
    data2.addColumn('number',  data_in[i].col);
    data2.addRows(data_in[i].data);

    // A list of numbers from 1 to i
    leftColumns = range(1, i);

    // Join the two tables into one view
    view = new google.visualization.data.join(view, data2, 'full', [[0,0]], leftColumns, [1]);
  }
  var tableOptions = {width: 'automatic'};

  var table = new google.visualization.Table(document.getElementById("tabs11"));
  table.draw(view, tableOptions);
}


function drawChart(data_in) {
  var numCurves = data_in.length;
  var view;
  var data2;

  // We have at least one curve
  data_in1 = data_in[0][0];

  var data1 = new google.visualization.DataTable();
  data1.addColumn('number', 'X');
  data1.addColumn('number', data_in[0][1].slice(13, -32));
  data1.addRows(data_in1);
  view = new google.visualization.DataView(data1);

  for (var i = 1; i < numCurves; i++){
    data_in2 = data_in[i][0];
    data2 = new google.visualization.DataTable();
    data2.addColumn('number', 'X');

    data2.addColumn('number',  data_in[i][1].slice(13, -32));
    data2.addRows(data_in2);

    // A list of numbers from 1 to i
    leftColumns = range(1, i);

    // Join the two tables into one view
    view = new google.visualization.data.join(view, data2, 'full', [[0,0]], leftColumns, [1]);
  }
  //$("#tabs3").text(view.toJSON());

  // Set chart options
  var chartOptions = {title:'Test Graph',
                 width:800,
                 height:600,
                 chartArea: {left: 50, width: "55%"},
                 hAxis: {title: 'x axis'},
                 vAxis: {title: 'y axis'},
                 'pointSize':2,
                 'lineWidth':1,
                 'interpolateNulls':true,
                };
  var tableOptions = {width: 'automatic'};

  // Instantiate and draw our chart, passing in some options.
  div = document.getElementById("poop");
  var chart = new google.visualization.LineChart(document.getElementById("tabs12"));
  var table = new google.visualization.Table(document.getElementById("tabs2"));
  chart.draw(view, chartOptions);
  table.draw(view, tableOptions);
}

</script>

<script>
$(function() {
  $( "#topcenter" ).resizable({
    handles: 's',
    stop: function(event, ui) {
      $(this).css("width", '');
    }
  });
});
</script>


<!-- ----------------------------------------------------------------------- -->
</head>

<body>

<div id ="main"> <!-- This div exists to test some Jquery binding things -->
<h1>WebM Development Dashboard</h1>

<div id="topcenter" class="ui-widget-content">

<div id="topcolumnsm">
  <div id="treeView1">
  </div>
</div>

<div id="topcolumnsm">
  <div id="treeView2">
  </div>
</div>

<div id="topcolumn">
  <div id="treeView3">
  </div>
</div>

<div id="topcolumn">
  <div id="treeView4">
  </div>
</div>

</div> <!-- end of top -->

<div id="bottomcenter">

<!-- the tab widget -->
<div id="tabs">
  <ul class="tabnav">
    <li><a href="#tabs1">Graph</a></li>
    <li><a href="#tabs2">Table</a></li>
    <li><a href="#tabs3">Notes</a></li>
  </ul>

  <div id="tabs1" class="tabdiv">
    <div id="tabs11"></div>
    <div id="tabs12"></div>
    <div class="clear"></div>
  </div>
  <div id="tabs2" class="tabdiv">
  </div>
  <div id="tabs3" class="tabdiv">
    <p>Lorem ipsum etc.</p>
  </div>

</div> <!-- end of tabs -->

<div id="clearer">
  <h3> Click here to clear all boxes. </h3>
</div>


<!-- 
<div id="button">
<input type="button" value="Test Ajax Calling Functionality" onclick="RequestTest()" />
</div>
<br>
<div id="result">
Hello
</div>
-->


</div> <!-- end of main -->


</body>
</html>
